<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-translate="ticket-edit">ุชุนุฏูู ุงูุชุฐูุฑุฉ - ูุธุงู ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ูุงูุณูุงูุฉ</title>

  <!-- ุงุณุชูุฑุงุฏ ุฎุท Tajawal -->
  <link
    href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap"
    rel="stylesheet"
  />
  <!-- Font Awesome ููุฃููููุงุช -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
  />
    <link rel="stylesheet" href="../css/shared.css"/>

  <!-- ุฑุงุจุท ุชูุณููุงุช ticket-details.css -->
  <link rel="stylesheet" href="/frontend/css/ticket-details.css" />
</head>
<body>
  <!-- ุงูููุฏุฑ -->
  <header class="main-header">
    <div class="header-container">
      <div class="system-title">
        <img src="/frontend/images/system-title.png" alt="ูุธุงู ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ูุงูุณูุงูุฉ" />
      </div>
      <div class="hospital-logo">
        <img src="/frontend/images/hospital-logo.png" alt="ุดุนุงุฑ ุงููุณุชุดูู" />
      </div>
    </div>
  </header>
  <div class="header-actions">
    <button class="back-btn" onclick="history.back()">
     <i class="fas fa-arrow-right" id="backIcon"></i>        
      </i><span data-translate="back">ุฑุฌูุน</span>
    </button>
    <button class="home-btn" onclick="window.location.href='index.html'">
      <i class="fas fa-home"></i><span data-translate="home">ุงูุฑุฆูุณูุฉ</span>
    </button>
  </div>

  <main class="content-wrapper">
    <h1 class="page-title" data-translate="ticket-edit">ุชุนุฏูู ุงูุชุฐูุฑุฉ</h1>

    <form id="editTicketForm" class="ticket-form" enctype="multipart/form-data">
      <!-- ุชูุงุตูู ุงูุญุฏุซ -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-file-lines section-icon"></i>
          <h2 class="section-title" data-translate="event-details">ุชูุงุตูู ุงูุญุฏุซ</h2>
        </div>
        <div class="section-content">
          <div class="field-row">
            <div class="field-group">
              <label for="event_date" class="field-label" data-translate="event-date">ุชุงุฑูุฎ ุงูุญุฏุซ</label>
              <input type="date" id="event_date" name="event_date" class="field-input" required />
            </div>
            <div class="field-group">
              <label for="event_time" class="field-label" data-translate="event-time">ููุช ุงูุญุฏุซ</label>
              <select id="event_time" name="event_time" class="field-input" required>
                <option value="ุตุจุงุญุงู" data-translate="morning">ุตุจุงุญุงู</option>
                <option value="ูุณุงุกู" data-translate="evening">ูุณุงุกู</option>
              </select>
            </div>
          </div>
          <div class="field-single">
            <label for="event_location" class="field-label" data-translate="event-location">ูููุน ุงูุญุฏุซ</label>
            <input type="text" id="event_location" name="event_location" class="field-input" required data-translate-placeholder="enter-event-location" placeholder="ุงุฏุฎู ูููุน ุงูุญุฏุซ ููุง" />
          </div>
          <div class="field-row">
            <div class="field-group">
              <label for="reporting_dept_id" class="field-label" data-translate="reporting-dept">ุงููุณู ุงููุจูุบ</label>
              <select id="reporting_dept_id" name="reporting_dept_id" class="field-input" required></select>
            </div>
            <div class="field-group">
              <label for="responding_dept_id" class="field-label" data-translate="responding-dept">ุงููุณู ุงููุณุชุฌูุจ</label>
              <select id="responding_dept_id" name="responding_dept_id" class="field-input" required></select>
            </div>
          </div>
        </div>
      </section>

      <!-- ูุนูููุงุช ุงููุฑูุถ -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-user-injured section-icon"></i>
          <h2 class="section-title" data-translate="patient-info">ูุนูููุงุช ุงููุฑูุถ</h2>
        </div>
        <div class="section-content">
          <div class="field-row">
            <div class="field-group">
              <label for="patient_name" class="field-label" data-translate="patient-name">ุงุณู ุงููุฑูุถ</label>
              <input type="text" id="patient_name" name="patient_name" class="field-input" data-translate-placeholder="enter-patient-name" placeholder="ุงุฏุฎู ุงุณู ุงููุฑูุถ" />
            </div>
            <div class="field-group">
              <label for="medical_record_no" class="field-label" data-translate="medical-record">ุฑูู ุงูููู ุงูุทุจู</label>
              <input type="text" id="medical_record_no" name="medical_record_no" class="field-input" data-translate-placeholder="enter-medical-record" placeholder="ุงุฏุฎู ุฑูู ุงูููู ุงูุทุจู" />
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label class="field-label" data-translate="gender">ุงูุฌูุณ</label>
              <select id="gender" name="gender" class="field-input">
                <option value="">โ</option>
                <option value="ุฐูุฑ" data-translate="male">ุฐูุฑ</option>
                <option value="ุฃูุซู" data-translate="female">ุฃูุซู</option>
              </select>
            </div>

          </div>
        </div>
      </section>

      <!-- ููุน ุงูุจูุงุบ -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-exclamation-triangle section-icon"></i>
          <h2 class="section-title" data-translate="report-type">ููุน ุงูุจูุงุบ</h2>
        </div>
        <div class="section-content">
            <select id="report_type" name="report_type" class="field-input" required>
              <option value="capacity-to-cause-error" data-translate="capacity-to-cause-error">ุงูุธุฑูู ุฃู ุงูุฃุญุฏุงุซ ุงูุชู ูุฏููุง ุงููุฏุฑุฉ ุนูู ุงูุชุณุจุจ ูู ุญุฏูุซ ุฎุทุฃ.</option>
              <option value="error-no-patient" data-translate="error-no-patient">ุญุฏุซ ุฎุทุฃ ูููู ูู ูุตู ุฃุซุฑู ุฅูู ุงููุฑูุถ.</option>
              <option value="error-no-harm" data-translate="error-no-harm">ุญุฏุซ ุฎุทุฃ ูุตู ุฃุซุฑู ุฅูู ุงููุฑูุถ ูููู ูู ูุณุจุจ ุถุฑุฑุงู ูู.</option>
              <option value="error-monitor" data-translate="error-monitor">ุญุฏุซ ุฎุทุฃ ูุตู ุฃุซุฑู ุฅูู ุงููุฑูุถ ูุชุทูุจ ุงููุชุงุจุนุฉ ููุชุฃูุฏ ูู ุนุฏู ุชุณุจุจู ูู ุถุฑุฑ ุจุงููุฑูุถ ุฃู ุชุทูุจ ุงูุชุฏุฎู ูููุน ุงูุถุฑุฑ ุฃู ุงูุฅุฌุฑุงุกุงุช ูุนุงู.</option>
              <option value="error-minor-harm" data-translate="error-minor-harm">ุญุฏุซ ุฎุทุฃ ูุฏ ูููู ูุฏ ุฃุณูู ูู ุญุฏูุซ ุถุฑุฑ ูุคูุช ูููุฑูุถ ุฃู ุฃุฏู ุฅูู ุฐูู ูุชุทูุจ ุงูุชุฏุฎู.</option>
              <option value="error-minor-harm-hospital" data-translate="error-minor-harm-hospital">ุญุฏุซ ุฎุทุฃ ูุฏ ูููู ูุฏ ุฃุณูู ูู ุญุฏูุซ ุถุฑุฑ ูุคูุช ูููุฑูุถ ุฃู ุฃุฏู ุฅูู ุฐูู ูุชุทูุจ ุงูุชูููู ุจุงููุณุชุดูู ููุชุฑุงุช ุจุณูุทุฉ ุฃู ููุชุฑุงุช ุทูููุฉ.</option>
              <option value="error-serious-harm" data-translate="error-serious-harm">ุญุฏุซ ุฎุทุฃ ูุฏ ูููู ูุฏ ุฃุณูู ูู ุถุฑุฑ ุฏุงุฆู ูููุฑูุถ ุฃู ุฃุฏู ุฅูู ุฐูู ุงูุถุฑุฑ.</option>
              <option value="error-life-threatening" data-translate="error-life-threatening">ุญุฏุซ ุฎุทุฃ ูุชุทูุจ ุงูุชุฏุฎู ุงูุถุฑูุฑู ูุฅููุงุฐ ุงูุญูุงุฉ.</option>
              <option value="error-death" data-translate="error-death">ุญุฏุซ ุฎุทุฃ ูุฏ ูููู ูุฏ ุฃุณูู ูู ููุงุฉ ุงููุฑูุถ ุฃู ุฃุฏู ุฅูู ููุงุชู.</option>
            </select>
        </div>
      </section>

      <!-- ูุตู ุงูุญุฏุซ -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-file-alt section-icon"></i>
          <h2 class="section-title" data-translate="event-description">ูุตู ุงูุญุฏุซ</h2>
        </div>
        <div class="section-content">
          <textarea
            id="event_description"
            name="event_description"
            class="field-input"
            rows="4"
            data-translate-placeholder="enter-event-description"
            placeholder="ุตู ุงูุญุฏุซ..."
            required
          ></textarea>
        </div>
      </section>

      <!-- ุจูุงูุงุช ุงููุจูุบ -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-user section-icon"></i>
          <h2 class="section-title" data-translate="reporter-info">ุจูุงูุงุช ุงููุจูุบ</h2>
        </div>
        <div class="section-content">
          <div class="field-row">
            <div class="field-group">
              <label for="reporter_name" class="field-label" data-translate="reporter-name">ุงูุงุณู</label>
              <input type="text" id="reporter_name" name="reporter_name" class="field-input" required data-translate-placeholder="enter-reporter-name" placeholder="ุงุฏุฎู ุงุณู ุงููุจูุบ" />
            </div>
            <div class="field-group">
              <label for="reporter_phone" class="field-label" data-translate="reporter-phone">ุฑูู ุงูุฌูุงู</label>
              <input type="tel" id="reporter_phone" name="reporter_phone" class="field-input" required data-translate-placeholder="placeholder-phone" placeholder="05XXXXXXXX" />
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label for="reporter_position" class="field-label" data-translate="reporter-position">ุงููุณูู ุงููุธููู</label>
              <input type="text" id="reporter_position" name="reporter_position" class="field-input" data-translate-placeholder="enter-reporter-position" placeholder="ุงุฏุฎู ุงููุณูู ุงููุธููู" />
            </div>
            <div class="field-group">
              <label for="reporter_email" class="field-label" data-translate="reporter-email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
              <input type="email" id="reporter_email" name="reporter_email" class="field-input" data-translate-placeholder="enter-email" placeholder="name@moh.gov.sa" />
            </div>
          </div>
        </div>
      </section>

      <!-- ุงูุฅุฌุฑุงุกุงุช ุงููุชุฎุฐุฉ -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-tools section-icon"></i>
          <h2 class="section-title" data-translate="actions-taken">ุงูุฅุฌุฑุงุกุงุช ุงููุชุฎุฐุฉ</h2>
        </div>
        <div class="section-content">
          <textarea
            id="actions_taken"
            name="actions_taken"
            class="field-input"
            rows="3"
            data-translate-placeholder="enter-actions"
            placeholder="ุงูุชุจ ุงูุฅุฌุฑุงุกุงุช ุงููุชุฎุฐุฉ..."
          ></textarea>
        </div>
      </section>

      <!-- ุชุตููู ุงูุญุฏุซ -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-th-large section-icon"></i>
          <h2 class="section-title" data-translate="event-classification">ุชุตููู ุงูุญุฏุซ</h2>
        </div>
        <div class="section-content tags-container" id="classificationContainer">
          <div class="checkbox-group" style="display:flex;flex-wrap:wrap;gap:12px;">
            <label><input type="checkbox" name="classification" value="ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูุฃูู" data-translate="security-issues"> <span data-translate="security-issues">ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูุฃูู</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุณููู" data-translate="behaviour"> <span data-translate="behaviour">ุงูุณููู</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูููุธููู" data-translate="staff-issues"> <span data-translate="staff-issues">ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูููุธููู</span></label>
            <label><input type="checkbox" name="classification" value="ุฅุฏุงุฑุฉ ุฑุนุงูุฉ ุงููุฑุถู" data-translate="patient-care-management"> <span data-translate="patient-care-management">ุฅุฏุงุฑุฉ ุฑุนุงูุฉ ุงููุฑุถู</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงููุฎุชุจุฑุงุช ุงูุทุจูุฉ" data-translate="lab-issues"> <span data-translate="lab-issues">ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงููุฎุชุจุฑุงุช ุงูุทุจูุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูุฅุฌุฑุงุกุงุช" data-translate="procedural"> <span data-translate="procedural">ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูุฅุฌุฑุงุกุงุช</span></label>
            <label><input type="checkbox" name="classification" value="ูุดููุงุช ุงูุฃุฌูุฒุฉ ุงูุทุจูุฉ" data-translate="medical-equipment-issues"> <span data-translate="medical-equipment-issues">ูุดููุงุช ุงูุฃุฌูุฒุฉ ุงูุทุจูุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุตูุงูุฉ ุงูููุดุขุช ุงูุตุญูุฉ" data-translate="facility-maintenance"> <span data-translate="facility-maintenance">ุตูุงูุฉ ุงูููุดุขุช ุงูุตุญูุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุณูุงูุฉ ุงูุจูุฆูุฉ" data-translate="environment-safety"> <span data-translate="environment-safety">ุงูุณูุงูุฉ ุงูุจูุฆูุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูุฅูุงูุฉ ูุงูุณูู" data-translate="accommodation-issues"> <span data-translate="accommodation-issues">ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูุฅูุงูุฉ ูุงูุณูู</span></label>
            <label><input type="checkbox" name="classification" value="ุงุงูุฃููุฑ ุงููุชุนููุฉ ุจุชูููุฉ ุงููุนูููุงุช" data-translate="it-issues"> <span data-translate="it-issues">ุงุงูุฃููุฑ ุงููุชุนููุฉ ุจุชูููุฉ ุงููุนูููุงุช</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุชุตููุฑ ุงูุทุจู ูุงูุฅุฌุฑุงุกุงุช ุงูุชุดุฎูุตูุฉ" data-translate="medical-imaging-diagnostic"> <span data-translate="medical-imaging-diagnostic">ุงูุชุตููุฑ ุงูุทุจู ูุงูุฅุฌุฑุงุกุงุช ุงูุชุดุฎูุตูุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุฎุฏูุงุช ุงูุชุบุฐูุฉ" data-translate="food-services"> <span data-translate="food-services">ุฎุฏูุงุช ุงูุชุบุฐูุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุชุบุฐูุฉ ุงูุณุฑูุฑูุฉ" data-translate="clinical-nutrition"> <span data-translate="clinical-nutrition">ุงูุชุบุฐูุฉ ุงูุณุฑูุฑูุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุฃููุฑ ุฐุงุช ุงูุนูุงูุฉ ุจููุงูุญุฉ ุงูุนุฏูู" data-translate="infection-control-issues"> <span data-translate="infection-control-issues">ุงูุฃููุฑ ุฐุงุช ุงูุนูุงูุฉ ุจููุงูุญุฉ ุงูุนุฏูู</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุตุญุฉ ุงูููููุฉ" data-translate="occupational-health"> <span data-translate="occupational-health">ุงูุตุญุฉ ุงูููููุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุฎุฏูุฉ ูุงูุชูุธูู" data-translate="housekeeping"> <span data-translate="housekeeping">ุงูุฎุฏูุฉ ูุงูุชูุธูู</span></label>
            <label><input type="checkbox" name="classification" value="ุฃููุฑ ูุชุนููุฉ ุจุงูุญูู ุงููุฑูุฏู" data-translate="intravenous"> <span data-translate="intravenous">ุฃููุฑ ูุชุนููุฉ ุจุงูุญูู ุงููุฑูุฏู</span></label>
            <label><input type="checkbox" name="classification" value="ุชูุฑุญุงุช ุงูุณุฑูุฑ (ุฅุตุงุจุฉ)" data-translate="pressure-ulcer"> <span data-translate="pressure-ulcer">ุชูุฑุญุงุช ุงูุณุฑูุฑ (ุฅุตุงุจุฉ)</span></label>
            <label><input type="checkbox" name="classification" value="ุฃููุฑ ูุชุนููุฉ ุจุณูุงูุฉ ุงูุฌูุฏ / ุงูุฅุตุงุจุงุช ุงูุฌูุฏูุฉ" data-translate="skin-lesions"> <span data-translate="skin-lesions">ุฃููุฑ ูุชุนููุฉ ุจุณูุงูุฉ ุงูุฌูุฏ / ุงูุฅุตุงุจุงุช ุงูุฌูุฏูุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุฃุฏููุฉ" data-translate="medication"> <span data-translate="medication">ุงูุฃุฏููุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุฃููุฑ ูุชุนููุฉ ุจุงูุชูุงุตู" data-translate="communication-issues"> <span data-translate="communication-issues">ุฃููุฑ ูุชุนููุฉ ุจุงูุชูุงุตู</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุณููุท" data-translate="fall"> <span data-translate="fall">ุงูุณููุท</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุนูุงุฌ ุงูุฅุดุนุงุนู (ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูุฃุดุนุฉ)" data-translate="radiation-treatment"> <span data-translate="radiation-treatment">ุงูุนูุงุฌ ุงูุฅุดุนุงุนู (ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูุฃุดุนุฉ)</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูููุงุฏุฉ ูุฃูู ุงูููุงุฏุฉ" data-translate="labor-delivery-issues"> <span data-translate="labor-delivery-issues">ุงูุฃููุฑ ุงููุชุนููุฉ ุจุงูููุงุฏุฉ ูุฃูู ุงูููุงุฏุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุฃููุฑ ุงููุชุนููุฉ ุจุณูุงุณู ุงูุฅูุฏุงุฏ" data-translate="supply-chain-issues"> <span data-translate="supply-chain-issues">ุงูุฃููุฑ ุงููุชุนููุฉ ุจุณูุงุณู ุงูุฅูุฏุงุฏ</span></label>
            <label><input type="checkbox" name="classification" value="ุฎุฏูุงุช ูุบุณูุฉ ุงูููุงุกุงุช" data-translate="laundry-services"> <span data-translate="laundry-services">ุฎุฏูุงุช ูุบุณูุฉ ุงูููุงุกุงุช</span></label>
            <label><input type="checkbox" name="classification" value="ุงูุฃุญุฏุงุซ ุงูุฌุณููุฉ" data-translate="sentinel-events"> <span data-translate="sentinel-events">ุงูุฃุญุฏุงุซ ุงูุฌุณููุฉ</span></label>
            <label><input type="checkbox" name="classification" value="ุงููููุฉ / ุงููุณุชูุฏุงุช ูุงููุซุงุฆู / ุงูุฅูุฑุงุฑุงุช" data-translate="id-docs-consent"> <span data-translate="id-docs-consent">ุงููููุฉ / ุงููุณุชูุฏุงุช ูุงููุซุงุฆู / ุงูุฅูุฑุงุฑุงุช</span></label>
          </div>
          <small class="hint" data-translate="classification-hint">ุงูุตู ุจูู ุงูุชุตูููุงุช ุจููุงุตู</small>
        </div>
      </section>

      <!-- ุชูุงุตูู ุงูุฅุตุงุจุฉ -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-info-circle section-icon"></i>
          <h2 class="section-title" data-translate="injury-details">ุชูุงุตูู ุงูุฅุตุงุจุฉ</h2>
        </div>
        <div class="section-content">
          <div class="field-row">
            <div class="field-group">
              <label class="field-label" data-translate="had-injury">ูู ุญุฏุซุช ุฅุตุงุจุฉุ</label>
              <select id="had_injury" name="had_injury" class="field-input">
                <option value="ูุง" data-translate="no">ูุง</option>
                <option value="ูุนู" data-translate="yes">ูุนู</option>
              </select>
            </div>
            <div class="field-group">
              <label class="field-label" data-translate="injury-type">ููุน ุงูุฅุตุงุจุฉ</label>
              <select id="injury_type" name="injury_type" class="field-input">
                <option value="">โ</option>
                <option value="ุฌุณุฏูุฉ" data-translate="physical">ุฌุณุฏูุฉ</option>
                <option value="ููุณูุฉ" data-translate="psychic">ููุณูุฉ</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- ูุฑููุงุช ุฌุฏูุฏุฉ -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-paperclip section-icon"></i>
          <h2 class="section-title" data-translate="attachments">ูุฑููุงุช (ุงุฎุชูุงุฑู)</h2>
        </div>
        <div class="section-content">
          <label for="attachmentsInput" data-translate="choose-file" style="margin-bottom:6px;display:block;cursor:pointer;">choose-file</label>
          <input type="file" name="attachments" id="attachmentsInput" multiple style="margin-bottom:4px;" />
          <div id="noFilesMsg" data-translate="no-files-selected" style="margin-top:8px;color:#888;font-size:0.95em">ูู ูุชู ุงุฎุชูุงุฑ ุฃู ูููุงุช</div>
        </div>
      </section>

      <!-- ุฃุฒุฑุงุฑ ุงูุฅุฑุณุงู -->
      <div class="form-actions" style="display:flex;gap:16px;justify-content:flex-end;flex-wrap:wrap;">
        <button type="submit" class="btn-primary" data-translate="save" style="min-width:120px;font-weight:bold;">ุญูุธ ุงูุชุนุฏููุงุช</button>
        <button type="button" class="btn-secondary" onclick="history.back()" data-translate="cancel" style="min-width:120px;">ุฅูุบุงุก</button>
      </div>
    </form>
  </main>
<script src="/frontend/js/language.js"></script>
<script>
  // โโโโโโโโโโโ 1) ูุชุบููุฑุงุช ุนุงููุฉ โโโโโโโโโโโ
  const form                  = document.getElementById('editTicketForm');
  const ticketId              = new URLSearchParams(location.search).get('id');
  const apiBase               = 'http://localhost:3006/api';
  const reportingDeptSelect   = document.getElementById('reporting_dept_id');
  const respondingDeptSelect  = document.getElementById('responding_dept_id');

  // โโโโโโโโโโโ 2) ุชุญููู ุงูุฃูุณุงู โโโโโโโโโโโ
async function loadDepartments() {
  try {
    const res = await fetch(`${apiBase}/departments`, {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });

    if (!res.ok) throw new Error(`Response not OK (${res.status})`);

    const body = await res.json();
    console.log('๐ฆ ุงุณุชุฌุงุจุฉ ุงูุฃูุณุงู:', body);

    // ูุฃู ุงูุงุณุชุฌุงุจุฉ ูุตูููุฉ ูุจุงุดุฑุฉ
    const depts = Array.isArray(body) ? body : [];
    if (!depts.length) throw new Error('ูุง ุชูุฌุฏ ุฃูุณุงู');

    reportingDeptSelect.innerHTML  = '<option value="" disabled selected data-translate="select-dept">ุงุฎุชุฑ ุงููุณู</option>';
    respondingDeptSelect.innerHTML = '<option value="" disabled selected data-translate="select-dept">ุงุฎุชุฑ ุงููุณู</option>';

   const lang = localStorage.getItem('language') || 'ar';

function getDeptName(name) {
  try {
    const parsed = JSON.parse(name);
    return parsed[lang] || parsed['ar'] || parsed['en'] || name;
  } catch {
    return name;
  }
}

depts.forEach(d => {
  const deptName = getDeptName(d.name);
  reportingDeptSelect.add(new Option(deptName, d.id));
  respondingDeptSelect.add(new Option(deptName, d.id));
});


  } catch (err) {
    console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุฃูุณุงู:', err);
    alert('ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุฃูุณุงู: ' + err.message);
  }
}


  // โโโโโโโโโโโ 3) ุชุญููู ุจูุงูุงุช ุงูุชุฐูุฑุฉ โโโโโโโโโโโ
async function loadTicket() {
  if (!ticketId) return;

  try {
    const res  = await fetch(`${apiBase}/tickets/${ticketId}`, {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });

    const json = await res.json();

    // ุฅุฐุง API ุฃุฑุฌุน ุงููุงุฆู ูุจุงุดุฑุฉ (ููุง ูู console) ููุง ููุชุธุฑ json.status
    let t;
    if (json.status === 'success' && json.data) {
      t = json.data;
    } else if (json.id !== undefined) {
      // ููุง ูุชุนุงูู ูุน ุงูุฌุณู ุงููุจุงุดุฑ
      t = json;
    } else {
      throw new Error(json.message || `Unexpected response structure`);
    }

    // ุงููุฃ ุงูุญููู
    Object.entries(t).forEach(([key, val]) => {
      const el = document.getElementById(key);
      if (el && ['INPUT','SELECT','TEXTAREA'].includes(el.tagName)) {
        // ููุชุงุฑูุฎ ุจุตูุบุฉ ISOุ ุฎุฐ ุงูุฌุฒุก ูุจู T
        el.value = key === 'event_date' && typeof val === 'string'
          ? val.split('T')[0]
          : val ?? '';
      }
    });

    // ุจุนุฏ ุฅุถุงูุฉ ุงูุฃูุณุงู:
    reportingDeptSelect.value  = t.reporting_dept_id || '';
    respondingDeptSelect.value = t.responding_dept_id  || '';
    if (Array.isArray(t.classifications)) {
      // ุฃูุบู ุชุญุฏูุฏ ุงููู ุฃููุงู
      document.querySelectorAll('input[name="classification"]').forEach(cb => {
        cb.checked = t.classifications.includes(cb.value);
      });
    }

  } catch (err) {
    alert('ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงูุชุฐูุฑุฉ: ' + err.message);
  }
}


  // โโโโโโโโโโโ 4) ุฅุฑุณุงู ุงูุชุนุฏููุงุช โโโโโโโโโโโ
form.addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData(form);

  // 1) ุฌูุน ุงูุชุตูููุงุช ุงููุฎุชุงุฑุฉ
  const selected = Array.from(
    document.querySelectorAll('input[name="classification"]:checked')
  ).map(cb => cb.value);

  // 2) ูุดูู ุฃู ุญููู classification ููุถูููุฉ
  fd.delete('classification');

  // 3) ูุถูู ูู ูููุฉ ูุญูู multi-part
  selected.forEach(val => {
    fd.append('classification', val);
  });

  // 4) ุงูุชุนููู ุงูุซุงุจุช
  fd.set('status_comments', 'ุชู ุงูุชุนุฏูู ูู ุงููุงุฌูุฉ');

  try {
    const res = await fetch(`${apiBase}/tickets/${ticketId}`, {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
      body: fd
    });
    const body = await res.json();
    if (!res.ok) throw new Error(body.message || res.statusText);
    alert('ุชู ุญูุธ ุงูุชุนุฏููุงุช ุจูุฌุงุญ');
    history.back();
  } catch (err) {
    alert('ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุชุนุฏููุงุช: ' + err.message);
  }
});


  // โโโโโโโโโโโ 5) ุชููุฆุฉ ุงูุตูุญุฉ โโโโโโโโโโโ
  document.addEventListener('DOMContentLoaded', async () => {
    await loadDepartments();
    await loadTicket();
  });

  // Add dynamic update for attachments input
  const attachmentsInput = document.getElementById('attachmentsInput');
  const noFilesMsg = document.getElementById('noFilesMsg');
  if (attachmentsInput && noFilesMsg) {
    attachmentsInput.addEventListener('change', function() {
      const lang = localStorage.getItem('language') || 'ar';
      if (attachmentsInput.files.length === 0) {
        noFilesMsg.textContent = getTranslation('no-files-selected');
      } else {
        noFilesMsg.textContent = Array.from(attachmentsInput.files).map(f => f.name).join(', ');
      }
    });
  }

  // After the dynamic update for attachments input
  // Ensure translation updates for file input label and noFilesMsg on language change
  window.addEventListener('storage', function(e) {
    if (e.key === 'language') {
      const lang = localStorage.getItem('language') || 'ar';
      const chooseFileLabel = document.querySelector('label[for="attachmentsInput"][data-translate="choose-file"]');
      if (chooseFileLabel) {
        chooseFileLabel.textContent = getTranslation('choose-file');
      }
      if (noFilesMsg) {
        noFilesMsg.textContent = getTranslation('no-files-selected');
      }
    }
  });
</script>
    <script src="/frontend/js/check-status.js"></script>


</body>
</html>
