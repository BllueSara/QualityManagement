<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-translate="ticket-edit">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø© - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©</title>

  <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø®Ø· Tajawal -->
  <link
    href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap"
    rel="stylesheet"
  />
  <!-- Font Awesome Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
  />
    <link rel="stylesheet" href="../css/shared.css"/>

  <!-- Ø±Ø§Ø¨Ø· ØªÙ†Ø³ÙŠÙ‚Ø§Øª ticket-details.css -->
  <link rel="stylesheet" href="/frontend/css/ticket-details.css" />
</head>
<body>
  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header class="main-header">
    <div class="header-container">
      <div class="system-title">
        <img src="/frontend/images/system-title.png" alt="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©" />
      </div>
      <div class="hospital-logo">
        <img src="/frontend/images/hospital-logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰" />
      </div>
    </div>
  </header>
  <div class="header-actions">
    <button class="back-btn" onclick="history.back()">
     <i class="fas fa-arrow-right" id="backIcon"></i>        
      </i><span data-translate="back">Ø±Ø¬ÙˆØ¹</span>
    </button>
    <button class="home-btn" onclick="window.location.href='index.html'">
      <i class="fas fa-home"></i><span data-translate="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </button>
  </div>

  <main class="content-wrapper">
    <h1 class="page-title" data-translate="ticket-edit">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±Ø©</h1>

    <form id="editTicketForm" class="ticket-form" enctype="multipart/form-data">
      <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-file-lines section-icon"></i>
          <h2 class="section-title" data-translate="event-details">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø«</h2>
        </div>
        <div class="section-content">
          <div class="field-row">
            <div class="field-group">
              <label for="event_date" class="field-label" data-translate="event-date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¯Ø«</label>
              <input type="date" id="event_date" name="event_date" class="field-input" required />
            </div>
            <div class="field-group">
              <label for="event_time" class="field-label" data-translate="event-time">ÙˆÙ‚Øª Ø§Ù„Ø­Ø¯Ø«</label>
              <input type="time" id="event_time" name="event_time" class="field-input" required />
            </div>
          </div>
          <div class="field-single">
            <label for="event_location" class="field-label" data-translate="event-location">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¯Ø«</label>
            <input type="text" id="event_location" name="event_location" class="field-input" required data-translate-placeholder="enter-event-location" placeholder="Ø§Ø¯Ø®Ù„ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù‡Ù†Ø§" />
          </div>
          <div class="field-row">
            <div class="field-group">
              <label for="reporting_dept_id" class="field-label" data-translate="reporting-dept">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø¨Ù„Øº</label>
              <select id="reporting_dept_id" name="reporting_dept_id" class="field-input" required></select>
            </div>
            <div class="field-group">
              <label for="responding_dept_id" class="field-label" data-translate="responding-dept">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¬ÙŠØ¨</label>
              <select id="responding_dept_id" name="responding_dept_id" class="field-input" required></select>
            </div>
            <div class="field-group">
              <label for="other_depts" class="field-label" data-translate="other-depts">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¢Ø®Ø± Ø§Ù„Ù…Ø¹Ù†ÙŠ</label>
              <select id="other_depts" name="other_depts" class="field-input" required>
                <option value="" disabled selected data-translate="placeholder-select-dept">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-user-injured section-icon"></i>
          <h2 class="section-title" data-translate="patient-info">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h2>
        </div>
        <div class="section-content">
          <div class="field-row">
            <div class="field-group">
              <label for="patient_name" class="field-label" data-translate="patient-name">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
              <input type="text" id="patient_name" name="patient_name" class="field-input" data-translate-placeholder="enter-patient-name" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" />
            </div>
            <div class="field-group">
              <label for="medical_record_no" class="field-label" data-translate="medical-record">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ</label>
              <input type="text" id="medical_record_no" name="medical_record_no" class="field-input" data-translate-placeholder="enter-medical-record" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ" />
            </div>
          </div>
          
        </div>
      </section>

      <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-exclamation-triangle section-icon"></i>
          <h2 class="section-title" data-translate="report-type">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº</h2>
        </div>
        <div class="section-content">
          <select id="report_type" name="report_type" class="field-input" required>
            <option value="Ø­Ø¯Ø« Ø¹Ø§Ø±Ø¶" data-translate="accident">Ø­Ø¯Ø« Ø¹Ø§Ø±Ø¶</option>
            <option value="Ø­Ø¯Ø« Ø¬Ø³ÙŠÙ…" data-translate="serious">Ø­Ø¯Ø« Ø¬Ø³ÙŠÙ…</option>
            <option value="Ø¥Ù„ØªÙ‚Ø§Ø·Ø© Ø¬ÙŠØ¯Ø©" data-translate="good-catch">Ø¥Ù„ØªÙ‚Ø§Ø·Ø© Ø¬ÙŠØ¯Ø©</option>
          </select>
        </div>
      </section>

      <!-- ØªØµÙ†ÙŠÙ Ø§Ù„Ø­Ø¯Ø« -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-th-large section-icon"></i>
          <h2 class="section-title" data-translate="event-classification">ØªØµÙ†ÙŠÙ Ø§Ù„Ø­Ø¯Ø«</h2>
        </div>
        <div class="section-content tags-container" id="classificationContainer">
          <div class="checkbox-group" id="classificationCheckboxes" style="display:flex;flex-wrap:wrap;gap:12px;">
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
          </div>
          <small class="hint" data-translate="classification-hint">Ø§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø¨ÙÙˆØ§ØµÙ„</small>
        </div>
      </section>

      <!-- ÙˆØµÙ Ø§Ù„Ø­Ø¯Ø« -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-file-alt section-icon"></i>
          <h2 class="section-title" data-translate="event-description">ÙˆØµÙ Ø§Ù„Ø­Ø¯Ø«</h2>
        </div>
        <div class="section-content">
          <textarea
            id="event_description"
            name="event_description"
            class="field-input"
            rows="4"
            data-translate-placeholder="enter-event-description"
            placeholder="ØµÙ Ø§Ù„Ø­Ø¯Ø«..."
            required
          ></textarea>
        </div>
      </section>
      <!-- Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø© -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-tools section-icon"></i>
          <h2 class="section-title" data-translate="actions-taken">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©</h2>
        </div>
        <div class="section-content">
          <textarea
            id="actions_taken"
            name="actions_taken"
            class="field-input"
            rows="3"
            data-translate-placeholder="enter-actions"
            placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©..."
          ></textarea>
        </div>
      </section>
      <!-- ===== Ù‚Ø³Ù…: Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ===== -->
      <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ØªØ§Ù„ÙŠ Ø³ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø§Ø¯Ù…Ù† Ùˆmanager_ovr Ø¹Ø¨Ø± Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨ØªØŒ Ù„Ø°Ø§ Ù†Ø­Ø°ÙÙ‡ Ù…Ù† HTML Ø§Ù„Ø¹Ø§Ù… -->
      <!--
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-paperclip section-icon"></i>
          <h2 class="section-title" data-translate="attachments">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h2>
        </div>
        <div class="section-content">
          <div id="attachmentsView" class="attachments-list">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ø­Ø§Ù„ÙŠØ©</div>
          <label for="attachmentsInput" data-translate="choose-file" style="margin-bottom:6px;display:block;cursor:pointer;">choose-file</label>
          <input type="file" name="attachments" id="attachmentsInput" multiple style="margin-bottom:4px;" />
          <div id="noFilesMsg" data-translate="no-files-selected" style="margin-top:8px;color:#888;font-size:0.95em">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„ÙØ§Øª</div>
        </div>
      </section>
      -->
      <!-- ===== Ù‚Ø³Ù…: ØªØµÙ†ÙŠÙ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¶Ø±Ø± ===== -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-exclamation-circle section-icon"></i>
          <h2 class="section-title" data-translate="event-classification-level">ØªØµÙ†ÙŠÙ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¶Ø±Ø± <span style="color:red">*</span></h2>
        </div>
        <div class="section-content">
          <div class="form-group required full-width">
            <label data-translate="level-of-harm-desc"> Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¶Ø±Ø± Ø§Ù„Ù†Ø§ØªØ¬ Ø¹Ù† Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¹Ø§Ø±Ø¶ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ÙˆØ¶Ø­ Ø£Ø¹Ù„Ø§Ù‡</label>
            <div id="levelOfHarmOptionsEdit" class="level-harm-grid">
              <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
          </div>
        </div>
      </section>
      <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ù„Øº -->
      <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ØªØ§Ù„ÙŠ Ø³ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø§Ø¯Ù…Ù† Ùˆmanager_ovr Ø¹Ø¨Ø± Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨ØªØŒ Ù„Ø°Ø§ Ù†Ø­Ø°ÙÙ‡ Ù…Ù† HTML Ø§Ù„Ø¹Ø§Ù… -->
      <!--
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-user section-icon"></i>
          <h2 class="section-title" data-translate="reporter-info">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ù„Øº</h2>
        </div>
        <div class="section-content">
          <div class="field-row">
            <div class="field-group">
              <label for="reporter_name" class="field-label" data-translate="reporter-name">Ø§Ù„Ø§Ø³Ù…</label>
              <input type="text" id="reporter_name" name="reporter_name" class="field-input" required data-translate-placeholder="enter-reporter-name" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù„Øº" />
            </div>
            <div class="field-group">
              <label for="reporter_phone" class="field-label" data-translate="reporter-phone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
              <input type="tel" id="reporter_phone" name="reporter_phone" class="field-input" required data-translate-placeholder="placeholder-phone" placeholder="05XXXXXXXX" />
            </div>
          </div>
          <div class="field-row">
            <div class="field-group">
              <label for="reporter_position" class="field-label" data-translate="reporter-position">Ø§Ù„Ù…Ø³Ù…ÙŠ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
              <input type="text" id="reporter_position" name="reporter_position" class="field-input" data-translate-placeholder="enter-reporter-position" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³Ù…ÙŠ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" />
            </div>
            <div class="field-group">
              <label for="reporter_email" class="field-label" data-translate="reporter-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
              <input type="email" id="reporter_email" name="reporter_email" class="field-input" data-translate-placeholder="enter-email" placeholder="name@moh.gov.sa" />
            </div>
          </div>
        </div>
      </section>
      -->



      <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ØµØ§Ø¨Ø© -->
      <section class="card-section">
        <div class="section-header">
          <i class="fas fa-info-circle section-icon"></i>
          <h2 class="section-title" data-translate="injury-details">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ØµØ§Ø¨Ø©</h2>
        </div>
        <div class="section-content">
          <div class="field-row">
            <div class="field-group">
              <label class="field-label" data-translate="had-injury">Ù‡Ù„ Ø­Ø¯Ø«Øª Ø¥ØµØ§Ø¨Ø©ØŸ</label>
              <select id="had_injury" name="had_injury" class="field-input">
                <option value="Ù„Ø§" data-translate="no">Ù„Ø§</option>
                <option value="Ù†Ø¹Ù…" data-translate="yes">Ù†Ø¹Ù…</option>
              </select>
            </div>
            <div class="field-group">
              <label class="field-label" data-translate="injury-type">Ù†ÙˆØ¹ Ø§Ù„Ø¥ØµØ§Ø¨Ø©</label>
              <select id="injury_type" name="injury_type" class="field-input">
                <option value="">â€”</option>
                <option value="Ø¬Ø³Ø¯ÙŠØ©" data-translate="physical">Ø¬Ø³Ø¯ÙŠØ©</option>
                <option value="Ù†ÙØ³ÙŠØ©" data-translate="psychic">Ù†ÙØ³ÙŠØ©</option>
              </select>
            </div>
          </div>
        </div>
      </section>





      <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
      <div class="form-actions" style="display:flex;gap:16px;justify-content:flex-end;flex-wrap:wrap;">
        <button type="submit" class="btn-primary" data-translate="save" style="min-width:120px;font-weight:bold;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button type="button" class="btn-secondary" onclick="history.back()" data-translate="cancel" style="min-width:120px;">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  </main>
<script src="/frontend/js/language.js"></script>
<script>
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 1) Ù…ØªØºÙŠÙ‘Ø±Ø§Øª Ø¹Ø§Ù…Ù‘Ø© â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  const form                  = document.getElementById('editTicketForm');
  const ticketId              = new URLSearchParams(location.search).get('id');
  const apiBase               = 'http://localhost:3006/api';
  const reportingDeptSelect   = document.getElementById('reporting_dept_id');
  const respondingDeptSelect  = document.getElementById('responding_dept_id');
  const otherDeptsSelect      = document.getElementById('other_depts');

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 2) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
async function loadDepartments() {
  try {
    const res = await fetch(`${apiBase}/departments`, {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });

    if (!res.ok) throw new Error(`Response not OK (${res.status})`);

    const body = await res.json();
    console.log('ğŸ“¦ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:', body);

    // Ù„Ø£Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…ØµÙÙˆÙØ© Ù…Ø¨Ø§Ø´Ø±Ø©
    const depts = Array.isArray(body) ? body : [];
    if (!depts.length) throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù…');

    reportingDeptSelect.innerHTML  = '<option value="" disabled selected data-translate="select-dept">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
    respondingDeptSelect.innerHTML = '<option value="" disabled selected data-translate="select-dept">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
    otherDeptsSelect.innerHTML     = '<option value="" disabled selected data-translate="placeholder-select-dept">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';

   const lang = localStorage.getItem('language') || 'ar';

function getDeptName(name) {
  try {
    const parsed = JSON.parse(name);
    return parsed[lang] || parsed['ar'] || parsed['en'] || name;
  } catch {
    return name;
  }
}

depts.forEach(d => {
  const deptName = getDeptName(d.name);
  reportingDeptSelect.add(new Option(deptName, d.id));
  respondingDeptSelect.add(new Option(deptName, d.id));
  otherDeptsSelect.add(new Option(deptName, d.id));
});


  } catch (err) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:', err);
    alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ' + err.message);
  }
}

async function loadClassifications(selectedValues = []) {
    const lang = localStorage.getItem('language') || 'ar';
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:3006/api/tickets/classifications?lang=${lang}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const result = await response.json();
    const container = document.getElementById('classificationCheckboxes');
    container.innerHTML = '';

    if (!result.data) {
      container.innerHTML = '<span style="color:red">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</span>';
      return;
    }

    result.data.forEach(classif => {
      const id = `cat_${classif.id}`;
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = id;
      checkbox.name = 'classification';
      checkbox.value = classif.id;
      if (selectedValues.includes(String(classif.id)) || selectedValues.includes(classif.id)) {
        checkbox.checked = true;
      }

      const label = document.createElement('label');
      label.htmlFor = id;
      label.textContent = classif.name;

      const wrapper = document.createElement('div');
      wrapper.style.display = 'inline-block';
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);

      container.appendChild(wrapper);
    });
  }

  async function loadHarmLevelsEdit(selectedId = null) {
    const lang = localStorage.getItem('language') || 'ar';
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:3006/api/tickets/harm-levels?lang=${lang}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const result = await response.json();
    const container = document.getElementById('levelOfHarmOptionsEdit');
    container.innerHTML = '';

    if (!result.data) {
      container.innerHTML = '<span style="color:red">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¶Ø±Ø±</span>';
      return;
    }

    result.data.forEach(level => {
      const id = `harm_edit_${level.id}`;
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.id = id;
      radio.name = 'harm_level_id';
      radio.value = level.id;
      radio.required = true;
      if (selectedId && String(selectedId) === String(level.id)) {
        radio.checked = true;
      }

      const label = document.createElement('label');
      label.htmlFor = id;
      label.innerHTML = `${level.name} <br><small>${level.desc}</small>`;

      const wrapper = document.createElement('div');
      wrapper.className = 'level-harm-option';
      wrapper.appendChild(radio);
      wrapper.appendChild(label);
      container.appendChild(wrapper);
    });
  }

  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 3) ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ°ÙƒØ±Ø© â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
async function loadTicket() {
  if (!ticketId) return;

  try {
    const res  = await fetch(`${apiBase}/tickets/${ticketId}`, {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });

    const json = await res.json();

    // Ø¥Ø°Ø§ API Ø£Ø±Ø¬Ø¹ Ø§Ù„ÙƒØ§Ø¦Ù† Ù…Ø¨Ø§Ø´Ø±Ø© (ÙƒÙ…Ø§ ÙÙŠ console) ÙÙ„Ø§ Ù†Ù†ØªØ¸Ø± json.status
    let t;
    if (json.status === 'success' && json.data) {
      t = json.data;
    } else if (json.id !== undefined) {
      // Ù‡Ù†Ø§ Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¬Ø³Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      t = json;
    } else {
      throw new Error(json.message || `Unexpected response structure`);
    }

    // Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„
    Object.entries(t).forEach(([key, val]) => {
      const el = document.getElementById(key);
      if (el && ['INPUT','SELECT','TEXTAREA'].includes(el.tagName)) {
        // Ù„Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© ISOØŒ Ø®Ø° Ø§Ù„Ø¬Ø²Ø¡ Ù‚Ø¨Ù„ T
        el.value = key === 'event_date' && typeof val === 'string'
          ? val.split('T')[0]
          : val ?? '';
      }
    });

    // Ø¨Ø¹Ø¯ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„: Ø­Ø¯Ø¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¶Ø±Ø±
    await loadHarmLevelsEdit(t.harm_level_id);

    // Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:
    reportingDeptSelect.value  = t.reporting_dept_id || '';
    respondingDeptSelect.value = t.responding_dept_id  || '';
    otherDeptsSelect.value     = t.other_depts || '';
    // Ø§Ø³ØªØ¯Ø¹Ù Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
    await loadClassifications(Array.isArray(t.classifications) ? t.classifications.map(String) : []);
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const attachmentsEl = document.getElementById('attachmentsView');
    if (attachmentsEl) {
      attachmentsEl.innerHTML = '';
      if (Array.isArray(t.attachments) && t.attachments.length) {
        t.attachments.forEach(att => {
          const filename = att.filename;
          const url = `http://localhost:3006/uploads/tickets/${filename}`;
          const link = document.createElement('a');
          link.href = url;
          link.target = '_blank';
          link.textContent = filename;
          link.style.display = 'block';
          link.style.marginBottom = '5px';
          attachmentsEl.appendChild(link);
        });
      } else {
        attachmentsEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ø­Ø§Ù„ÙŠØ©';
      }
    }

  } catch (err) {
    alert('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ°ÙƒØ±Ø©: ' + err.message);
  }
}


  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 4) Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
form.addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData(form);

  // 1) Ø¬Ù…Ø¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
  const selected = Array.from(
    document.querySelectorAll('input[name="classification"]:checked')
  ).map(cb => cb.value);

  // 2) Ù†Ø´ÙŠÙ„ Ø£ÙŠ Ø­Ù‚ÙˆÙ„ classification Ù…ÙØ¶Ù…Ù‘Ù†Ø©
  fd.delete('classification');

  // 3) Ù†Ø¶ÙŠÙ ÙƒÙ„ Ù‚ÙŠÙ…Ø© ÙƒØ­Ù‚Ù„ multi-part
  selected.forEach(val => {
    fd.append('classification', val);
  });

  // 4) ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙˆÙ‚Øª Ø¨Ø¯ÙˆÙ† Ø«ÙˆØ§Ù†ÙŠ
  let eventTime = fd.get('event_time') || '';
  if (eventTime.includes(':')) {
    const parts = eventTime.split(':');
    eventTime = parts[0] + ':' + parts[1];
    fd.set('event_time', eventTime);
  }

  // 5) Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø«Ø§Ø¨Øª
  fd.set('status_comments', 'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');

  try {
    const res = await fetch(`${apiBase}/tickets/${ticketId}`, {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
      body: fd
    });
    const body = await res.json();
    if (!res.ok) throw new Error(body.message || res.statusText);
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    history.back();
  } catch (err) {
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
  }
});


  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 5) ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  document.addEventListener('DOMContentLoaded', async () => {
    await loadDepartments();
    await loadTicket();
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª ÙˆØ§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    const eventTimeInput = document.getElementById('event_time');
    if (eventTimeInput && !eventTimeInput.value) {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      eventTimeInput.value = `${hh}:${min}`;
    }
  });

  // Add dynamic update for attachments input
  const attachmentsInput = document.getElementById('attachmentsInput');
  const noFilesMsg = document.getElementById('noFilesMsg');
  if (attachmentsInput && noFilesMsg) {
    attachmentsInput.addEventListener('change', function() {
      const lang = localStorage.getItem('language') || 'ar';
      if (attachmentsInput.files.length === 0) {
        noFilesMsg.textContent = getTranslation('no-files-selected');
      } else {
        noFilesMsg.textContent = Array.from(attachmentsInput.files).map(f => f.name).join(', ');
      }
    });
  }

  // After the dynamic update for attachments input
  // Ensure translation updates for file input label and noFilesMsg on language change
  window.addEventListener('storage', function(e) {
    if (e.key === 'language') {
      const lang = localStorage.getItem('language') || 'ar';
      const chooseFileLabel = document.querySelector('label[for="attachmentsInput"][data-translate="choose-file"]');
      if (chooseFileLabel) {
        chooseFileLabel.textContent = getTranslation('choose-file');
      }
      if (noFilesMsg) {
        noFilesMsg.textContent = getTranslation('no-files-selected');
      }
    }
  });
</script>
    <script src="/frontend/js/check-status.js"></script>


</body>
</html>
